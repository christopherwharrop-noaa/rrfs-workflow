#!/usr/bin/env bash
# shellcheck disable=SC1090,SC1091,SC2154
set -x
date
rundir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
HOMErrfs="$(dirname "$rundir")"

# Get environment config path
rrfs_config_file="${1:-}"

EXEC="${HOMErrfs}/sorc/WPS/ungrib/src/ungrib.exe"

if [[ -z "${rrfs_config_file}" ]]; then
  # Use unportable configuration and build method
  COMPILER=${COMPILER:-intel}

  source "${HOMErrfs}/workflow/tools/detect_machine.sh"
  source "${HOMErrfs}/workflow/tools/init.sh"

  if [[ "${MACHINE}" == "wcoss2" ]]; then
    BUILD_VERSION_FILE="${HOMErrfs}/versions/build.ver"
    if [[ -f "${BUILD_VERSION_FILE}" ]]; then
      source "${BUILD_VERSION_FILE}"
    fi
  fi

  set +x
  module purge                      
  module use "${HOMErrfs}/modulefiles"
  module load "rrfs/${MACHINE}.${COMPILER}"
  module list
  set -x

  echo "compiling WPS..."
  cd "${HOMErrfs}/sorc/WPS" || exit 1
  ./clean
  if [[ "${MACHINE}" == "wcoss2" ]]; then
    cp ../_workaround_/WPS/configure.wps_wcoss2 configure.wps
  elif [[ "${MACHINE}" == "gaeac6" ]] || [[ "${MACHINE}" == "orion" || "${MACHINE}" == "hercules" || "${MACHINE}" == "ursa" ]]; then
    mkdir -p .tmpNETCDFDIR/include
    mkdir -p .tmpNETCDFDIR/lib
    ln -snf "${netcdf_c_ROOT}"/include/* .tmpNETCDFDIR/include
    ln -snf "${netcdf_c_ROOT}"/lib/* .tmpNETCDFDIR/lib
    ln -snf "${netcdf_fortran_ROOT}"/include/* .tmpNETCDFDIR/include
    ln -snf "${netcdf_fortran_ROOT}"/lib/* .tmpNETCDFDIR/lib
    export NETCDF=${HOMErrfs}/sorc/WPS/.tmpNETCDFDIR
    module load jasper/2.0.32
    echo "19" | ./configure --nowrf
  else
    echo "19" | ./configure --nowrf
  fi
  ./compile ungrib

  if [[ "${MACHINE}" == "gaeac6" ]] || [[ "${MACHINE}" == "orion" || "${MACHINE}" == "hercules" || "${MACHINE}" == "ursa" ]]; then
    cd ungrib/src || exit 1
    ifort -o ungrib.exe  misc_definitions_module.o debug_cio.o module_debug.o module_stringutil.o \
      table.o module_datarray.o gridinfo.o new_storage.o filelist.o ungrib.o output.o rrpr.o \
      rd_grib1.o file_delete.o datint.o rd_grib2.o ./ngl/w3/libw3.a ./ngl/g2/libg2_4.a \
      -L"${jasper_ROOT}/lib64" -ljasper -L"${libpng_ROOT}/lib64" -lpng -lz libpgu.a
  fi

else
  # Use portable configuration and build method

  config_path="$( cd "$( dirname "${rrfs_config_file}" )" &> /dev/null && pwd )"
  rrfs_config_file="${config_path}/$(basename "${rrfs_config_file}")"

  # Set up the environment
  set +x
  source "${HOMErrfs}/workflow/tools/configure.sh" "${rrfs_config_file}" "wps" || exit 1
  module list
  set -x

  # Set up RRFS FIX file path
  source "${HOMErrfs}/workflow/tools/portable_init.sh"

  echo "compiling WPS..."
  cd "${HOMErrfs}/sorc/WPS" || exit 1
  ./clean

  # Get hardware architecture
  os=$(uname -m)

  # Apply patches
  patch_path="${HOMErrfs}/sorc/_workaround_/WPS/patches"
  patch -N -p1 < ${patch_path}/arch.Config.pl.patch
  patch -N -p1 < ${patch_path}/preamble.patch
  patch -N -p1 < ${patch_path}/configure.patch
  if [[ ${os} = "aarch64" ]]; then
    patch -N -p1 < ${patch_path}/for_aarch64.patch
  fi
  # Jasper lib may be in lib or lib64 depending on the system
  export JASPERLIB=$(dirname $(find -L ${jasper_ROOT} -name libjasper.so))
  export JASPERINC=${jasper_ROOT}/include
  export NETCDF=${netcdf_c_ROOT}
  export NETCDFF=${netcdf_fortran_ROOT}
  c_compiler=$(basename "${CC}")
  if [[ "${c_compiler}" == "gcc" ]]; then
    build_option=3
  elif [[ "${c_compiler}" == "icx" ]]; then
    build_option=19
  elif [[ "${c_compiler}" == "icc" ]]; then
    build_option=23
  else
    echo "Error: Unsupported compiler ${c_compiler}"
    exit 1
  fi
  echo "C compiler is ${c_compiler}, using build option ${build_option}"
  echo "${build_option}" | ./configure --nowrf

  # Make sure the configuration's Fortran compiler matches the contents of $FC.
  # NOTE: This is necessary because sometimes the environment uses
  # Intel LLVM C with Intel Classic Fortran (i.e. $CC=icx and $FC=ifort)
  # The WPS build system doesn't allow for that combination, so we have to
  # explicitly set the Fortran compiler in configure.wps
  fortran_compiler=$(basename "${FC}")
  sed -i "s/^\(SFC[[:space:]]*=[[:space:]]*\).*$/\1$fortran_compiler/" configure.wps

  # Build Ungrib
  ./compile ungrib

fi

mkdir -p "${HOMErrfs}/exec"
echo "copy ${EXEC} to ../exec/ungrib.x"
cp "${EXEC}" "${HOMErrfs}/exec/ungrib.x"
exit 0
