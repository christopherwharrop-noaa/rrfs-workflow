#!/usr/bin/env bash
rundir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
HOMErrfs="$(dirname "$rundir")"

usage() {
  echo "Usage: $0 [<config_file>] [chem] [noda]"
  echo "  <config_file> - Path to the RRFS configuration YAML file. Default is 'config/config.yaml'."
  echo "  chem - Build MPAS-Model with chemistry support."
  echo "  noda - Skip building RDAS component."
  exit 1
}

# kill the whole build process if Ctrl+C is entered
# shellcheck disable=SC2317
cleanup() {
  echo "Caught Ctrl+C. Killing all background processes..."
  pkill -P $$  # Kills all child processes of this script
  exit 1
}
trap cleanup SIGINT SIGTERM

# Set default options
da="on"
chem="off"
rrfs_config_file="${HOMErrfs}/config/config.yaml"

# Parse command line arguments
if [ "$#" -gt 3 ]; then
  usage
  exit 1
fi
for arg in "$@"; do
  lower_arg=$(echo "$arg" | tr '[:upper:]' '[:lower:]')
  if [[ "$lower_arg" == "chem" ]]; then
    # handle chem option
    chem="on"
  elif [[ "$lower_arg" == "noda" ]]; then
    # handle noda option
    da="off"
  else
    rrfs_config_file="$arg"
  fi
done

if [[ "${chem}" == "on" ]]; then
  cd "${HOMErrfs}/sorc" || exit 1
  echo "Option 'chem' found in the command line, downloading chem-specific MPAS-Model ......"
  remote_url="https://github.com/cheMPAS-Fire/MPAS-Model"
  branch_commit="chem/develop"  # a branch name or a commit hash
  mv MPAS-Model "MPAS-Model.$(date +%s)" # save a copy of current MPAS-Model
  git clone "${remote_url}" MPAS-Model
  cd "${HOMErrfs}/sorc/MPAS-Model" || exit 1
  git checkout "${branch_commit}"
  git submodule update --init --recursive
  # allow smoke_coarse in histlist_3d_smoke
  cp "${HOMErrfs}/fix/chemistry/mpassit/histlist_3d_smoke.coarse" "${HOMErrfs}/fix/chemistry/mpassit/histlist_3d_smoke"
fi
cd "${HOMErrfs}/sorc" || exit 1

echo "building all components, it may take more than one hour..."
./build.wps ${rrfs_config_file} &> ./log.build.wps  2>&1 &
./build.mpas ${rrfs_config_file} &> ./log.build.mpas 2>&1 &
./build.upp ${rrfs_config_file} &> ./log.build.upp  2>&1 &
./build.mpassit ${rrfs_config_file} &> ./log.build.mpassit  2>&1 &
./build.utils ${rrfs_config_file} &> ./log.build.utils  2>&1 &
./build.rank_run ${rrfs_config_file} &> ./log.build.rank_run  2>&1 &

if [[ "${da}" == "on" ]]; then
  ./build.rdas ${rrfs_config_file} &> ./log.build.rdas 2>&1 &
else
  echo "Option 'noda' found in the command line, skipping RDAS build."
fi

wait
nEXEC=$(find ../exec/* | wc -l)
echo "check the exec/ directory ==== a total of ${nEXEC} executables"
ls -lrth ../exec
echo "check the build logs ===="
ls -lrth log.build.*

exit 0
