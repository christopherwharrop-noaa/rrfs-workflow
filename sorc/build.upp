#!/usr/bin/env bash
# shellcheck disable=SC1091
set -x
date
rundir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
HOMErrfs="$(dirname "$rundir")"

# Get environment config path
rrfs_config_file="${1:-}"

EXEC="${HOMErrfs}/sorc/UPP/exec/upp.x"

rm -rf "${HOMErrfs}/sorc/UPP/tests/build"
rm -rf "${HOMErrfs}/sorc/UPP/tests/install"
rm -rf "${EXEC}"

cd "${HOMErrfs}/sorc/UPP/tests" || exit 1

if [[ -z "${rrfs_config_file}" ]]; then
    # Use unportable configuration and build method
    source "${HOMErrfs}/workflow/tools/detect_machine.sh"
    source "${HOMErrfs}/workflow/tools/init.sh"

    ./compile_upp.sh
else
    # Use portable configuration and build method
    config_path="$( cd "$( dirname "${rrfs_config_file}" )" &> /dev/null && pwd )"
    rrfs_config_file="${config_path}/$(basename "${rrfs_config_file}")"

    # Get fix files location from config
    set +x
    source "${HOMErrfs}/workflow/tools/configure.sh" "${rrfs_config_file}" "fix" || exit 1
    module list
    set -x

    # Set up RRFS FIX file path
    source "${HOMErrfs}/workflow/tools/portable_init.sh"

    # Copy portable build scripts to UPP
    cp "${HOMErrfs}/sorc/_workaround_/UPP/tests/compile_upp.sh" "${HOMErrfs}/sorc/UPP/tests/compile_upp.sh"
    cp "${HOMErrfs}/sorc/_workaround_/UPP/tests/configure.sh" "${HOMErrfs}/sorc/UPP/tests/configure.sh"
    cp "${HOMErrfs}/sorc/_workaround_/UPP/tests/readyaml" "${HOMErrfs}/sorc/UPP/tests/readyaml"

    ./compile_upp.sh -y "${rrfs_config_file}"
fi


mkdir -p "${HOMErrfs}/exec"
echo "copy ${EXEC} to ../exec/upp.x"
cp "${EXEC}" "${HOMErrfs}/exec/upp.x"

exit 0
